<!DOCTYPE html>
<html lang="en" data-theme="forest">
<head>
  <meta charset="UTF-8" />
  <title>Buggy</title>
  <style>
    @font-face {
      font-family: 'BuggyFont';
      src: url('../assets/fonts/Bold-Regular.otf') format('opentype');
    }

    [data-theme="forest"]   { --bg:#2d3a2e; --surface:#3d4f3e; --accent:#a8c090; --accent-text:#1a2a1b; --accent2:#4a6340; --text:#f0ead6; --muted:#8a9e7a; --shadow:rgba(0,0,0,0.5); }
    [data-theme="babyblue"] { --bg:#d6eaf8; --surface:#eaf4fc; --accent:#5dade2; --accent-text:#1a4a6e; --accent2:#aed6f1; --text:#1a3a52; --muted:#7fb3d3; --shadow:rgba(93,173,226,0.25); }
    [data-theme="gingham"]  { --bg:#fdf6f0; --surface:#fff9f5; --accent:#c0392b; --accent-text:#fff;    --accent2:#fadbd8; --text:#3d1c1c; --muted:#b07070; --shadow:rgba(192,57,43,0.15); }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: transparent;
      font-family: 'Segoe UI', sans-serif;
      color: var(--text);
      width: 220px; height: 320px;
      overflow: hidden;
      user-select: none;
    }

    .overlay {
      width: 100%; height: 100%;
      background: var(--bg);
      border-radius: 20px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 14px 14px;
      position: relative;
    }

    .drag-handle {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 50px;
      -webkit-app-region: drag;
      border-radius: 20px 20px 0 0;
    }

    .controls {
      position: absolute;
      top: 10px; right: 10px;
      display: flex;
      gap: 4px;
      -webkit-app-region: no-drag;
      z-index: 5;
    }
    .ctrl-btn {
      background: none; border: none;
      color: var(--muted); font-size: 12px;
      cursor: pointer; padding: 3px 7px;
      border-radius: 6px;
    }
    .ctrl-btn:hover { color: var(--text); background: var(--accent2); }

    .sprite-area {
      width: 70px; height: 70px;
      margin-bottom: 8px;
      flex-shrink: 0;
      cursor: pointer;
      -webkit-app-region: no-drag;
    }
    .sprite-area img {
      width: 100%; height: 100%;
      object-fit: contain;
      image-rendering: pixelated;
    }
    .bounce { animation: bounce 0.4s ease; }
    @keyframes bounce {
      0%,100% { transform: translateY(0); }
      40%      { transform: translateY(-10px); }
      70%      { transform: translateY(-4px); }
    }

    .speech {
      background: var(--accent2);
      border-radius: 10px;
      padding: 7px 10px;
      font-family: 'BuggyFont', 'Segoe UI', sans-serif;
      font-size: 11px;
      line-height: 1.4;
      text-align: center;
      width: 100%;
      min-height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .timer {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.02em;
      font-variant-numeric: tabular-nums;
      margin-bottom: 2px;
      -webkit-font-smoothing: antialiased;
    }
    .task-label {
      font-size: 12px;
      color: var(--text);
      text-align: center;
      width: 100%;
      padding: 2px 6px;
      line-height: 1.3;
      font-weight: 600;
    }
    .goal-label {
      font-size: 10px;
      color: var(--muted);
      text-align: center;
      width: 100%;
      padding: 0 6px;
      line-height: 1.3;
      margin-bottom: 4px;
    }

    .progress-bar {
      width: 100%; height: 4px;
      background: var(--accent2);
      border-radius: 2px;
      margin-top: 8px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width 1s linear;
      width: 100%;
    }

    .end-btn {
      background: none;
      border: 1px solid var(--accent2);
      border-radius: 8px;
      color: var(--muted);
      font-size: 10px;
      padding: 4px 12px;
      cursor: pointer;
      margin-top: 8px;
      transition: all 0.15s;
      -webkit-app-region: no-drag;
      font-family: 'Segoe UI', sans-serif;
    }
    .end-btn:hover { color: var(--accent); border-color: var(--accent); }

    /* Extend screen */
    .extend-overlay {
      display: none;
      position: absolute; inset: 0;
      background: var(--bg);
      border-radius: 20px;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      text-align: center;
      gap: 10px;
      z-index: 10;
      -webkit-app-region: no-drag;
    }
    .extend-overlay.visible { display: flex; }
    .extend-sprite { width: 70px; height: 70px; }
    .extend-sprite img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }
    .extend-msg { font-family: 'BuggyFont', 'Segoe UI', sans-serif; font-size: 12px; line-height: 1.4; text-transform: uppercase; }
    .extend-buttons { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
    .extend-btn {
      background: var(--accent2);
      border: none; border-radius: 10px;
      color: var(--text);
      padding: 8px 14px;
      cursor: pointer;
      font-size: 12px; font-weight: 600;
      font-family: 'Segoe UI', sans-serif;
      transition: all 0.15s;
    }
    .extend-btn:hover { background: var(--accent); color: var(--accent-text); }
    .extend-btn.done {
      background: var(--accent);
      color: var(--accent-text);
    }

    /* Done screen */
    .done-overlay {
      display: none;
      position: absolute; inset: 0;
      background: var(--bg);
      border-radius: 20px;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      text-align: center;
      gap: 10px;
      z-index: 10;
      -webkit-app-region: no-drag;
    }
    .done-overlay.visible { display: flex; }
    .done-sprite { width: 70px; height: 70px; }
    .done-sprite img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }
    .done-msg { font-family: 'BuggyFont', 'Segoe UI', sans-serif; font-size: 12px; line-height: 1.4; text-transform: uppercase; }
    .done-time { font-size: 11px; color: var(--muted); }
    .close-done-btn {
      background: var(--accent);
      border: none; border-radius: 10px;
      color: var(--accent-text);
      padding: 8px 20px;
      cursor: pointer;
      font-size: 13px; font-weight: 600;
      font-family: 'Segoe UI', sans-serif;
    }
  </style>
</head>
<body>
  <div class="overlay">
    <div class="drag-handle"></div>
    <div class="controls">
      <button class="ctrl-btn" title="Minimize" onclick="window.creature.minimizeOverlay()">─</button>
      <button class="ctrl-btn" title="Close" onclick="window.creature.closeOverlay()">✕</button>
    </div>

    <div class="sprite-area" onclick="poke()" id="sprite">
      <img src="../assets/sprites/focused.png" id="sprite-img" />
    </div>

    <div class="speech" id="speech"></div>
    <div class="timer" id="timer">--:--</div>
    <div class="task-label" id="task-label">...</div>
    <div class="goal-label" id="goal-label"></div>

    <div class="progress-bar" id="progress-bar">
      <div class="progress-fill" id="progress-fill"></div>
    </div>

    <button class="end-btn" id="end-btn" onclick="endEarly()">give up (for now)</button>
  </div>

  <!-- Extend screen (timer complete) -->
  <div class="extend-overlay" id="extend-overlay">
    <div class="extend-sprite">
      <img src="../assets/sprites/celebrating.png" />
    </div>
    <div class="extend-msg" id="extend-msg">Time's up!</div>
    <div class="extend-buttons">
      <button class="extend-btn" onclick="extend(10)">+10 min</button>
      <button class="extend-btn" onclick="extend(25)">+25 min</button>
      <button class="extend-btn done" onclick="finishSession()">I'm done</button>
    </div>
  </div>

  <!-- Done screen -->
  <div class="done-overlay" id="done-overlay">
    <div class="done-sprite">
      <img src="../assets/sprites/celebrating.png" id="done-sprite-img" />
    </div>
    <div class="done-msg" id="done-msg"></div>
    <div class="done-time" id="done-time"></div>
    <button class="close-done-btn" onclick="window.creature.closeOverlay()">Done</button>
  </div>

  <script>
    let totalSeconds = 0
    let isFlowMode = false
    let autoEndTimer = null

    function formatTime(s) {
      const mins = Math.floor(Math.abs(s) / 60)
      const secs = Math.abs(s) % 60
      return `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`
    }

    function poke() {
      if (isFlowMode) return // Don't nag in flow mode
      window.creature.getSnark('distracted')
      const el = document.getElementById('sprite')
      el.classList.remove('bounce')
      void el.offsetWidth
      el.classList.add('bounce')
      setSprite('judging')
      setTimeout(() => setSprite('focused'), 2000)
    }

    function setSprite(name) {
      document.getElementById('sprite-img').src = `../assets/sprites/${name}.png`
    }

    function playStartSound() {
      try {
        if (!document.hasFocus()) return // Don't play if window not focused
        const ctx = new (window.AudioContext || window.webkitAudioContext)()
        const notes = [523.25, 659.25, 783.99]
        notes.forEach((freq, i) => {
          const osc = ctx.createOscillator()
          const gain = ctx.createGain()
          osc.connect(gain)
          gain.connect(ctx.destination)
          osc.frequency.value = freq
          osc.type = 'sine'
          gain.gain.setValueAtTime(0.15, ctx.currentTime + i * 0.08)
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.08 + 0.4)
          osc.start(ctx.currentTime + i * 0.08)
          osc.stop(ctx.currentTime + i * 0.08 + 0.5)
        })
        // Clean up context after sounds finish
        setTimeout(() => ctx.close().catch(() => {}), 1000)
      } catch (e) {
        console.log('Could not play sound:', e)
      }
    }

    function playEndSound() {
      try {
        if (!document.hasFocus()) return // Don't play if window not focused
        const ctx = new (window.AudioContext || window.webkitAudioContext)()
        const notes = [783.99, 987.77, 1174.66, 1318.51]
        notes.forEach((freq, i) => {
          const osc = ctx.createOscillator()
          const gain = ctx.createGain()
          osc.connect(gain)
          gain.connect(ctx.destination)
          osc.frequency.value = freq
          osc.type = 'sine'
          gain.gain.setValueAtTime(0.12, ctx.currentTime + i * 0.1)
          gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + i * 0.1 + 0.6)
          osc.start(ctx.currentTime + i * 0.1)
          osc.stop(ctx.currentTime + i * 0.1 + 0.7)
        })
        // Clean up context after sounds finish
        setTimeout(() => ctx.close().catch(() => {}), 1500)
      } catch (e) {
        console.log('Could not play sound:', e)
      }
    }

    function endEarly() {
      if (confirm('End the session early?')) {
        window.creature.endSessionEarly()
      }
    }

    function extend(minutes) {
      clearTimeout(autoEndTimer)
      document.getElementById('extend-overlay').classList.remove('visible')
      window.creature.extendSession(minutes)
    }

    function finishSession() {
      clearTimeout(autoEndTimer)
      window.creature.endSession()
    }

    // Session started
    window.creature.onSessionStarted(({ task, sessionGoal, totalSeconds: total, message, theme, isFlowMode: flow }) => {
      totalSeconds = total
      isFlowMode = flow
      if (theme) document.documentElement.setAttribute('data-theme', theme)
      document.getElementById('task-label').textContent = task
      document.getElementById('goal-label').textContent = sessionGoal || ''
      document.getElementById('speech').textContent = message
      document.getElementById('timer').textContent = formatTime(total)
      document.getElementById('progress-fill').style.width = isFlowMode ? '0%' : '100%'
      document.getElementById('progress-bar').style.display = isFlowMode ? 'none' : 'block'
      document.getElementById('end-btn').textContent = isFlowMode ? "I'm done" : 'give up (for now)'
      setSprite('focused')
      playStartSound()
    })

    // Session restored (overlay was closed and reopened)
    window.creature.onSessionRestored(({ task, sessionGoal, secondsLeft, totalSeconds: total, theme, isFlowMode: flow }) => {
      totalSeconds = total
      isFlowMode = flow
      if (theme) document.documentElement.setAttribute('data-theme', theme)
      document.getElementById('task-label').textContent = task
      document.getElementById('goal-label').textContent = sessionGoal || ''
      document.getElementById('timer').textContent = formatTime(secondsLeft)
      document.getElementById('progress-bar').style.display = isFlowMode ? 'none' : 'block'
      document.getElementById('end-btn').textContent = isFlowMode ? "I'm done" : 'give up (for now)'
      if (!isFlowMode && total > 0) {
        const pct = (secondsLeft / total) * 100
        document.getElementById('progress-fill').style.width = `${pct}%`
      }
      setSprite('focused')
    })

    // Session extended
    window.creature.onSessionExtended(({ newSeconds, message }) => {
      totalSeconds += newSeconds
      document.getElementById('speech').textContent = message
      document.getElementById('timer').textContent = formatTime(newSeconds)
      setSprite('focused')
    })

    // Timer tick
    window.creature.onTick(({ secondsLeft, isFlowMode: flow }) => {
      document.getElementById('timer').textContent = formatTime(secondsLeft)
      if (!flow && totalSeconds > 0) {
        const pct = Math.max(0, (secondsLeft / totalSeconds) * 100)
        document.getElementById('progress-fill').style.width = `${pct}%`
      }
    })

    // Timer complete (show extend screen)
    window.creature.onTimerComplete(({ message }) => {
      document.getElementById('extend-msg').textContent = message
      document.getElementById('extend-overlay').classList.add('visible')
      setSprite('celebrating')
      playEndSound()

      // Auto-end after 5 minutes if no action
      autoEndTimer = setTimeout(() => {
        window.creature.endSession()
      }, 300000)
    })

    // Snark message
    window.creature.onSnarkMessage(msg => {
      document.getElementById('speech').textContent = msg
    })

    // Site detected
    window.creature.onSiteDetected(({ site }) => {
      setSprite('judging')
      const el = document.getElementById('sprite')
      el.classList.remove('bounce')
      void el.offsetWidth
      el.classList.add('bounce')
      setTimeout(() => setSprite('focused'), 4000)
    })

    // Session ended
    window.creature.onSessionEnded(({ message, early, minutesCompleted }) => {
      const spriteImg = early ? 'judging' : 'celebrating'
      document.getElementById('done-sprite-img').src = `../assets/sprites/${spriteImg}.png`
      document.getElementById('done-msg').textContent = message
      document.getElementById('done-time').textContent = minutesCompleted > 0 ? `${minutesCompleted} minutes focused` : ''
      document.getElementById('extend-overlay').classList.remove('visible')
      document.getElementById('done-overlay').classList.add('visible')
      if (!early) playEndSound()
    })

    // Check if there's an active session to restore
    window.creature.restoreSession()

    // ESC key to minimize overlay
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        window.creature.minimizeOverlay()
      }
    })
  </script>
</body>
</html>
